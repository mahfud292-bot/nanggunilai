<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Daftar Nilai Digital - SMA Negeri 1 Banggai</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- JSPDF for PDF Generation (New) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .sticky-col-left { position: sticky; left: 0; z-index: 20; }
        .sticky-col-left-2 { position: sticky; left: 48px; z-index: 20; } /* 48px is approx width of first col */
        .sticky-col-right { position: sticky; right: 0; z-index: 30; } /* Increased z-index */
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col z-30 transition-transform duration-300 md:translate-x-0 -translate-x-full fixed md:relative h-full">
        <div class="p-6 border-b border-slate-100 flex items-center gap-3">
            <div class="bg-indigo-600 p-2 rounded-lg">
                <i data-lucide="graduation-cap" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-900 leading-tight">EduGrade</h1>
                <p class="text-xs text-slate-500 font-medium">Digital Gradebook</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4">
            <p class="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Daftar Kelas XI</p>
            <nav id="class-nav" class="space-y-1">
                <!-- Class buttons generated by JS -->
            </nav>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full">
        
        <!-- Header -->
        <header class="bg-slate-900 border-b border-slate-800 relative overflow-hidden shrink-0">
            <!-- Decorative Background -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-y-1/2 translate-x-1/2"></div>
            <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 translate-y-1/2 -translate-x-1/2"></div>

            <div class="relative px-6 py-8"> <!-- Added padding top/bottom -->
                <!-- Layout Changed: Removed flex-row, now always flex-col -->
                <div class="flex flex-col gap-6">
                    
                    <!-- Top Section: Menu & Text Info -->
                    <div class="flex items-start gap-4">
                        <button id="menu-btn" class="md:hidden p-2 text-slate-400 hover:text-white hover:bg-white/10 rounded-lg mt-1">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-2 mb-3">
                                <span class="px-2 py-1 rounded text-[10px] font-bold tracking-wider uppercase bg-indigo-500/20 text-indigo-300 border border-indigo-500/30">APLIKASI DAFTAR NILAI DIGITAL</span>
                                <span class="px-2 py-1 rounded text-[10px] font-bold tracking-wider uppercase bg-blue-500/20 text-blue-300 border border-blue-500/30">PENILAIAN SEMESTER 2</span>
                                <span id="header-class-badge" class="px-2 py-1 rounded text-[10px] font-bold tracking-wider uppercase bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">KELAS XI A</span>
                            </div>
                            <h1 class="text-3xl font-bold text-white tracking-tight mb-4">SMA NEGERI 1 BANGGAI</h1>
                            
                            <!-- Info Rows (Vertical Stack) -->
                            <div class="space-y-2 text-sm text-slate-300">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="book-open" class="w-4 h-4 text-yellow-400"></i>
                                    <span class="font-medium text-slate-200">Mata Pelajaran: BAHASA INGGRIS</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="users" class="w-4 h-4 text-emerald-400"></i>
                                    <span>Guru Mapel: <span class="text-white font-medium">Mahfud S. Paukunding, S.Pd., M.Pd., Gr</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Section: Search & Buttons (Always Full Width Row) -->
                    <div class="flex items-center gap-3 w-full mt-2">
                        <div class="relative flex-1"> <!-- Flex-1 makes search take remaining space -->
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="search-input" placeholder="Cari siswa..." class="w-full bg-slate-800/50 border border-slate-700 text-slate-200 placeholder:text-slate-500 text-sm rounded-lg pl-9 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500/50 transition-all">
                        </div>
                        
                        <!-- Buttons -->
                        <button onclick="downloadPDF()" class="bg-emerald-600 hover:bg-emerald-500 text-white p-3 rounded-lg shadow-lg shadow-emerald-900/20 transition-all active:scale-95" title="Download Laporan PDF">
                            <i data-lucide="download" class="w-5 h-5"></i>
                        </button>
                        
                        <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg shadow-lg shadow-indigo-900/20 transition-all active:scale-95">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>

                </div>
            </div>
        </header>

        <!-- Stats Bar -->
        <!-- Changed to grid-cols-1 to match stacked look in screenshot -->
        <div class="px-6 py-4 grid grid-cols-1 gap-4 shrink-0">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex items-center gap-4"> <!-- Increased padding -->
                <div class="p-4 bg-blue-50 text-blue-600 rounded-xl">
                    <i data-lucide="users" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium mb-1">Jumlah Siswa</p>
                    <p id="stat-student-count" class="text-3xl font-bold text-slate-900">0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex items-center gap-4">
                <div class="p-4 bg-emerald-50 text-emerald-600 rounded-xl">
                    <i data-lucide="award" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium mb-1">Rata-Rata Kelas</p>
                    <p id="stat-class-average" class="text-3xl font-bold text-slate-900">0</p>
                </div>
            </div>
        </div>

        <!-- Table Area -->
        <div class="flex-1 overflow-auto px-6 pb-6">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
                <div class="overflow-auto flex-1 relative">
                    <table class="w-full text-sm text-left border-collapse" id="grade-table">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 z-30 shadow-sm" id="table-head">
                            <!-- Headers generated by JS -->
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="table-body">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Tambah Siswa -->
    <div id="add-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">Tambah Siswa Baru</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="new-student-name" placeholder="Contoh: Muhammad Farhan" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Kelas Target</label>
                    <div id="modal-class-display" class="w-full px-4 py-2 bg-slate-100 text-slate-600 rounded-lg border border-slate-200">
                        XI A
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors">
                    Batal
                </button>
                <button onclick="addStudent()" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- DATA & STATE ---
        const CLASSES = ["XI A", "XI B", "XI C", "XI D", "XI E", "XI F", "XI G", "XI H"];
        const INITIAL_COLUMNS = {
            tugas: [{ id: 'tugas_1', label: '1' }],
            vocab: [{ id: 'vocab_1', label: '1' }],
            percakapan: [{ id: 'cakap_1', label: '1' }],
            uh: [{ id: 'uh_1', label: '1' }]
        };

        let state = {
            students: JSON.parse(localStorage.getItem('gradebook_html_students')) || [],
            columns: JSON.parse(localStorage.getItem('gradebook_html_columns')) || INITIAL_COLUMNS,
            selectedClass: localStorage.getItem('gradebook_html_class') || "XI A",
            searchQuery: "",
            editingId: null,
            editNameValue: ""
        };

        // --- CORE FUNCTIONS ---

        function saveData() {
            localStorage.setItem('gradebook_html_students', JSON.stringify(state.students));
            localStorage.setItem('gradebook_html_columns', JSON.stringify(state.columns));
            localStorage.setItem('gradebook_html_class', state.selectedClass);
            renderApp();
        }

        function calculateAverage(scores) {
            const categories = ['tugas', 'vocab', 'percakapan', 'uh'];
            let categorySums = [];
            
            categories.forEach(cat => {
                const colIds = state.columns[cat].map(c => c.id);
                const validScores = colIds.map(id => parseInt(scores[id] || 0));
                const sum = validScores.reduce((a, b) => a + b, 0);
                const avg = colIds.length > 0 ? sum / colIds.length : 0;
                categorySums.push(avg);
            });

            const uasScore = parseInt(scores.uas || 0);
            categorySums.push(uasScore);

            const finalSum = categorySums.reduce((a, b) => a + b, 0);
            return Math.round(finalSum / 5);
        }

        function getGrade(avg) {
            if (avg >= 90) return { label: 'A', color: 'bg-green-100 text-green-700' };
            if (avg >= 80) return { label: 'B', color: 'bg-blue-100 text-blue-700' };
            if (avg >= 70) return { label: 'C', color: 'bg-yellow-100 text-yellow-700' };
            if (avg >= 60) return { label: 'D', color: 'bg-purple-100 text-purple-700' };
            return { label: 'E', color: 'bg-red-100 text-red-700' };
        }

        // --- DOM MANIPULATION ---

        function renderSidebar() {
            const nav = document.getElementById('class-nav');
            nav.innerHTML = '';
            
            CLASSES.forEach(cls => {
                const count = state.students.filter(s => s.class === cls).length;
                const isActive = state.selectedClass === cls;
                
                const btn = document.createElement('button');
                btn.className = `w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors mb-1 ${
                    isActive ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'
                }`;
                btn.onclick = () => {
                    state.selectedClass = cls;
                    if(window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile
                    saveData();
                };
                
                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="users" class="w-4 h-4 ${isActive ? 'text-indigo-600' : 'text-slate-400'}"></i>
                        ${cls}
                    </div>
                    <span class="text-xs bg-white border border-slate-200 px-2 py-0.5 rounded-full text-slate-500">${count}</span>
                `;
                nav.appendChild(btn);
            });
        }

        function renderHeader() {
            document.getElementById('header-class-badge').textContent = `KELAS ${state.selectedClass}`; // Uppercase matches screenshot
            document.getElementById('modal-class-display').textContent = state.selectedClass;
        }

        function renderTable() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            
            // --- 1. RENDER HEADERS ---
            const { tugas, vocab, percakapan, uh } = state.columns;
            
            let headerRow1 = `
                <tr>
                    <th rowspan="2" class="px-6 py-4 font-semibold w-12 border-b border-r border-slate-200 bg-slate-50 sticky-col-left">#</th>
                    <th rowspan="2" class="px-6 py-4 font-semibold min-w-[250px] border-b border-r border-slate-200 bg-slate-50 sticky-col-left-2">Nama Siswa</th>
            `;

            const renderCatHeader = (label, icon, key, cols) => `
                <th colspan="${cols.length}" class="px-2 py-2 text-center border-b border-r border-slate-200 bg-slate-100">
                    <div class="flex items-center justify-center gap-2 text-slate-700">
                        <i data-lucide="${icon}" class="w-4 h-4"></i>
                        <span>${label}</span>
                        <button onclick="addColumn('${key}')" class="p-1 hover:bg-slate-200 rounded-full text-indigo-600" title="Tambah Kolom">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        </button>
                    </div>
                </th>
            `;

            headerRow1 += renderCatHeader('Tugas', 'file-text', 'tugas', tugas);
            headerRow1 += renderCatHeader('Vocab', 'brain', 'vocab', vocab);
            headerRow1 += renderCatHeader('Cakap', 'mic', 'percakapan', percakapan);
            headerRow1 += renderCatHeader('UH', 'pen-tool', 'uh', uh);

            // UPDATED HEADER: Nilai Akhir not sticky, Aksi is sticky
            headerRow1 += `
                    <th rowspan="2" class="px-4 py-4 font-semibold text-center w-24 border-b border-slate-200 bg-indigo-50/30">
                       <div class="flex flex-col items-center gap-1">
                        <i data-lucide="graduation-cap" class="w-4 h-4 text-indigo-500"></i>
                        <span class="text-indigo-600">UAS</span>
                      </div>
                    </th>
                    <th rowspan="2" class="px-6 py-4 font-semibold text-center w-24 border-b border-slate-200 bg-slate-50">Nilai Akhir</th>
                    <th rowspan="2" class="px-4 py-4 font-semibold text-center w-20 border-b border-slate-200 sticky-col-right bg-slate-50 shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.1)]">Aksi</th>
                </tr>
            `;

            let headerRow2 = `<tr>`;
            const renderSubHeader = (key, cols) => {
                return cols.map((col, idx) => `
                    <th class="px-2 py-2 font-medium text-center w-16 border-b border-r border-slate-200 bg-slate-50 group relative">
                        <div class="flex items-center justify-center">
                            <span>${idx + 1}</span>
                            ${cols.length > 1 ? `
                                <button onclick="removeColumn('${key}', '${col.id}')" class="absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                            ` : ''}
                        </div>
                    </th>
                `).join('');
            };

            headerRow2 += renderSubHeader('tugas', tugas);
            headerRow2 += renderSubHeader('vocab', vocab);
            headerRow2 += renderSubHeader('percakapan', percakapan);
            headerRow2 += renderSubHeader('uh', uh);
            headerRow2 += `</tr>`;

            thead.innerHTML = headerRow1 + headerRow2;

            // --- 2. RENDER ROWS ---
            tbody.innerHTML = '';
            
            const filteredStudents = state.students
                .filter(s => s.class === state.selectedClass)
                .filter(s => s.name.toLowerCase().includes(state.searchQuery.toLowerCase()));

            // Update Stats
            document.getElementById('stat-student-count').textContent = filteredStudents.length;
            const totalAvg = filteredStudents.reduce((acc, curr) => acc + calculateAverage(curr.scores), 0);
            const classAvg = filteredStudents.length ? Math.round(totalAvg / filteredStudents.length) : 0;
            document.getElementById('stat-class-average').textContent = classAvg;

            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="50" class="px-6 py-12 text-center text-slate-400 bg-slate-50/50">
                            <div class="flex flex-col items-center gap-3">
                                <i data-lucide="users" class="w-12 h-12 text-slate-300"></i>
                                <p>Belum ada data siswa di kelas ini.</p>
                                <button onclick="openModal()" class="text-indigo-600 font-medium hover:underline text-sm">Tambah Siswa Baru</button>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                filteredStudents.forEach((student, index) => {
                    const avg = calculateAverage(student.scores);
                    const grade = getGrade(avg);
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors group";

                    // Helper to create input cells
                    const createInputCells = (cols) => cols.map(col => `
                        <td class="px-1 py-3 text-center border-r border-slate-100">
                            <input type="number" min="0" max="100" 
                                value="${student.scores[col.id] || 0}" 
                                onchange="updateScore(${student.id}, '${col.id}', this.value)"
                                class="w-12 text-center py-1 rounded border border-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-slate-700 text-sm">
                        </td>
                    `).join('');

                    // Name Cell Logic
                    let nameCellContent;
                    if (state.editingId === student.id) {
                        nameCellContent = `
                            <div class="flex items-center gap-2">
                                <input type="text" id="edit-name-${student.id}" value="${state.editNameValue}" 
                                    class="w-full px-2 py-1 text-sm border border-indigo-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                    onkeydown="if(event.key === 'Enter') saveName(${student.id})">
                                <button onclick="saveName(${student.id})" class="p-1 text-green-600 hover:bg-green-100 rounded">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        nameCellContent = `
                            <div class="flex items-center justify-between group/edit cursor-pointer" onclick="startEditing(${student.id}, '${student.name.replace(/'/g, "\\'")}')" title="Klik untuk edit nama">
                                <span>${student.name}</span>
                                <i data-lucide="pencil" class="w-3 h-3 text-slate-300 opacity-0 group-hover/edit:opacity-100 hover:text-indigo-600"></i>
                            </div>
                        `;
                    }

                    // UPDATED ROW: Nilai Akhir not sticky, Aksi is sticky with background
                    tr.innerHTML = `
                        <td class="px-6 py-3 text-slate-500 border-r border-slate-100 sticky-col-left bg-white group-hover:bg-slate-50">${index + 1}</td>
                        <td class="px-6 py-3 font-medium text-slate-800 border-r border-slate-100 sticky-col-left-2 bg-white group-hover:bg-slate-50 z-10">
                            ${nameCellContent}
                        </td>
                        
                        ${createInputCells(tugas)}
                        ${createInputCells(vocab)}
                        ${createInputCells(percakapan)}
                        ${createInputCells(uh)}

                        <td class="px-2 py-3 text-center bg-indigo-50/20">
                             <input type="number" min="0" max="100" value="${student.scores.uas || 0}" 
                                onchange="updateScore(${student.id}, 'uas', this.value)"
                                class="w-14 text-center py-1 rounded border border-indigo-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 text-slate-800 font-medium bg-white">
                        </td>

                        <td class="px-6 py-3 text-center border-l border-slate-200">
                            <div class="flex flex-col items-center justify-center gap-1">
                                <span class="font-bold text-slate-800">${avg}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${grade.color}">${grade.label}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center sticky-col-right bg-white group-hover:bg-slate-50 shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.05)] border-l border-slate-200 z-10">
                            <button onclick="deleteStudent(${student.id})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Hapus Siswa (Keluar/Pindah)">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            lucide.createIcons();
        }

        function renderApp() {
            renderSidebar();
            renderHeader();
            renderTable();
            lucide.createIcons();
        }

        // --- ACTIONS ---

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for better column fit

            // School Header
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text('SMA NEGERI 1 BANGGAI', 14, 15);
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text('DAFTAR NILAI SEMESTER 2 (GENAP)', 14, 22);
            
            // Metadata
            doc.setFontSize(10);
            doc.text(`Kelas: ${state.selectedClass}`, 14, 30);
            doc.text('Mata Pelajaran: BAHASA INGGRIS', 14, 35);
            doc.text('Guru: Mahfud S. Paukunding, S.Pd., M.Pd., Gr', 14, 40);
            
            const timestamp = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            doc.text(`Tanggal Cetak: ${timestamp}`, 14, 45);

            // Construct Headers
            // Flattened structure: No | Nama | T1 | T2... | V1... | C1... | U1... | UAS | Akhir | Pred
            const headers = ['No', 'Nama Siswa'];
            
            state.columns.tugas.forEach((_, i) => headers.push(`Tgs ${i+1}`));
            state.columns.vocab.forEach((_, i) => headers.push(`Voc ${i+1}`));
            state.columns.percakapan.forEach((_, i) => headers.push(`Ckp ${i+1}`));
            state.columns.uh.forEach((_, i) => headers.push(`UH ${i+1}`));
            
            headers.push('UAS');
            headers.push('Nilai Akhir');
            headers.push('Predikat');

            // Construct Data
            const filteredStudents = state.students
                .filter(s => s.class === state.selectedClass)
                .sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically for PDF

            const body = filteredStudents.map((s, i) => {
                const row = [i + 1, s.name];
                
                // Add scores based on column order
                state.columns.tugas.forEach(col => row.push(s.scores[col.id] || 0));
                state.columns.vocab.forEach(col => row.push(s.scores[col.id] || 0));
                state.columns.percakapan.forEach(col => row.push(s.scores[col.id] || 0));
                state.columns.uh.forEach(col => row.push(s.scores[col.id] || 0));
                
                row.push(s.scores.uas || 0);
                
                const avg = calculateAverage(s.scores);
                const grade = getGrade(avg);
                
                row.push(avg);
                row.push(grade.label);
                
                return row;
            });

            // Generate Table
            doc.autoTable({
                head: [headers],
                body: body,
                startY: 50,
                theme: 'grid',
                styles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    halign: 'center'
                },
                columnStyles: {
                    0: { cellWidth: 10 }, // No
                    1: { halign: 'left', cellWidth: 50 } // Nama
                },
                headStyles: { 
                    fillColor: [30, 41, 59], // Slate-800
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [241, 245, 249] // Slate-100
                }
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text('Aplikasi Daftar Nilai Digital - SMA Negeri 1 Banggai', 14, doc.internal.pageSize.height - 10);
                doc.text('Page ' + i + ' of ' + pageCount, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
            }

            doc.save(`Nilai_Siswa_${state.selectedClass.replace(/\s+/g, '_')}.pdf`);
        }

        function updateScore(id, field, value) {
            let num = parseInt(value);
            if (isNaN(num)) num = 0;
            if (num > 100) num = 100;
            if (num < 0) num = 0;

            const sIndex = state.students.findIndex(s => s.id === id);
            if (sIndex > -1) {
                state.students[sIndex].scores[field] = num;
                saveData();
                // Focusing issue: re-rendering entire table loses focus. 
                // For a simple HTML version, full re-render is easiest but causes UX issue.
                // We will rely on onchange (triggers on blur/enter) so focus loss is acceptable.
            }
        }

        function addColumn(category) {
            const currentCols = state.columns[category];
            const nextNum = currentCols.length + 1;
            const prefix = category === 'percakapan' ? 'cakap' : category;
            const newId = `${prefix}_${Date.now()}`;
            
            state.columns[category].push({ id: newId, label: `${nextNum}` });
            saveData();
        }

        function removeColumn(category, colId) {
            if (state.columns[category].length <= 1) {
                alert("Minimal harus ada 1 kolom nilai.");
                return;
            }
            if(confirm("Hapus kolom ini? Nilai di dalamnya akan hilang.")) {
                state.columns[category] = state.columns[category].filter(c => c.id !== colId);
                saveData();
            }
        }

        function addStudent() {
            const name = document.getElementById('new-student-name').value;
            if (!name.trim()) return;

            state.students.push({
                id: Date.now(),
                name: name,
                class: state.selectedClass,
                scores: {}
            });
            
            document.getElementById('new-student-name').value = '';
            closeModal();
            saveData();
        }

        // UPDATED: More robust delete function
        function deleteStudent(id) {
            if(confirm("Yakin ingin menghapus siswa ini? Data akan hilang permanen.")) {
                // Ensure type safety between number/string ID
                state.students = state.students.filter(s => s.id != id);
                saveData();
            }
        }

        function startEditing(id, currentName) {
            state.editingId = id;
            state.editNameValue = currentName;
            renderApp();
            // Focus on input after render
            setTimeout(() => {
                const input = document.getElementById(`edit-name-${id}`);
                if(input) {
                    input.focus();
                    input.select();
                }
            }, 50);
        }

        function saveName(id) {
            const input = document.getElementById(`edit-name-${id}`);
            const newName = input ? input.value : state.editNameValue;
            
            if (newName.trim()) {
                const sIndex = state.students.findIndex(s => s.id === id);
                if (sIndex > -1) {
                    state.students[sIndex].name = newName;
                }
            }
            state.editingId = null;
            state.editNameValue = "";
            saveData();
        }

        // --- UI HANDLERS ---
        function openModal() {
            const modal = document.getElementById('add-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('new-student-name').focus();
            }, 100);
        }

        function closeModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }
        
        // Sidebar Toggle for Mobile
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        function toggleSidebar() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        
        document.getElementById('menu-btn').onclick = toggleSidebar;
        overlay.onclick = toggleSidebar;

        // Search Listener
        document.getElementById('search-input').addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderTable(); // Only re-render table for search
        });

        // Init
        renderApp();
    </script>
</body>
</html>
